<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Nano Banana Admin</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #111;
            color: #eee;
        }
        h1 {
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }
        th, td {
            border: 1px solid #333;
            padding: 6px 8px;
            text-align: left;
        }
        th {
            background: #222;
        }
        tr:nth-child(even) {
            background: #181818;
        }
        input, button {
            background: #222;
            border: 1px solid #555;
            color: #eee;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
        }
        button {
            cursor: pointer;
        }
        button:hover {
            background: #333;
        }
        .small {
            font-size: 12px;
            color: #888;
        }
        .flex {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Nano Banana Admin</h1>
    <div class="flex">
        <label>Admin token: <input id="token" type="password" placeholder="ADMIN_TOKEN из .env"></label>
        <button onclick="loadUsers()">Загрузить пользователей</button>
    </div>
    <div class="flex">
        <label>Telegram user id: <input id="uid" type="text" placeholder="123456789"></label>
        <label>Новый баланс: <input id="bal" type="number" value="0"></label>
        <button onclick="setBalance()">Сохранить баланс</button>
    </div>
    <div id="status" class="small"></div>

    <table id="users-table">
        <thead>
            <tr>
                <th>telegram_user_id</th>
                <th>username</th>
                <th>Имя</th>
                <th>Баланс</th>
                <th>ref_code</th>
                <th>referred_by</th>
                <th>Приглашено</th>
                <th>created_at</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        async function loadUsers() {
            const token = document.getElementById('token').value.trim();
            if (!token) {
                document.getElementById('status').textContent = 'Введите токен.';
                return;
            }
            document.getElementById('status').textContent = 'Загружаю...';
            try {
                const res = await fetch('/api/admin/users?token=' + encodeURIComponent(token));
                const data = await res.json();
                if (!res.ok || data.error) {
                    document.getElementById('status').textContent = data.error || 'Ошибка загрузки';
                    return;
                }
                const tbody = document.querySelector('#users-table tbody');
                tbody.innerHTML = '';
                (data.users || []).forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${u.telegram_user_id}</td>
                        <td>${u.username || ''}</td>
                        <td>${(u.first_name || '') + ' ' + (u.last_name || '')}</td>
                        <td>${u.balance}</td>
                        <td>${u.ref_code || ''}</td>
                        <td>${u.referred_by || ''}</td>
                        <td>${u.referred_count}</td>
                        <td>${u.created_at}</td>
                    `;
                    tr.onclick = () => {
                        document.getElementById('uid').value = u.telegram_user_id;
                        document.getElementById('bal').value = u.balance;
                    };
                    tbody.appendChild(tr);
                });
                document.getElementById('status').textContent = 'Загружено: ' + (data.users || []).length;
            } catch (e) {
                document.getElementById('status').textContent = 'Ошибка сети: ' + e.message;
            }
        }

        async function setBalance() {
            const token = document.getElementById('token').value.trim();
            const uid = document.getElementById('uid').value.trim();
            const bal = document.getElementById('bal').value.trim();
            if (!token || !uid || bal === '') {
                document.getElementById('status').textContent = 'Нужны токен, user id и баланс.';
                return;
            }
            document.getElementById('status').textContent = 'Обновляю баланс...';
            try {
                const res = await fetch('/api/admin/set-balance?token=' + encodeURIComponent(token), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegram_user_id: uid, balance: parseInt(bal, 10) })
                });
                const data = await res.json();
                if (!res.ok || data.error) {
                    document.getElementById('status').textContent = data.error || 'Ошибка обновления';
                    return;
                }
                document.getElementById('status').textContent = 'Баланс обновлён.';
                await loadUsers();
            } catch (e) {
                document.getElementById('status').textContent = 'Ошибка сети: ' + e.message;
            }
        }
    </script>
</body>
</html>

